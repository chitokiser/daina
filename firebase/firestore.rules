// /firebase/firestore.rules
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() {
      return request.auth != null;
    }

    function myRole() {
      return signedIn()
        ? get(/databases/$(database)/documents/roles/$(request.auth.uid)).data.role
        : null;
    }

    function isAdmin() { return myRole() == "admin"; }
    function isEmployer() { return myRole() == "employer"; }

    match /users/{userId} {
      allow read: if (!("approved" in resource.data)) || resource.data.approved == true;
      allow create: if isAdmin();
      allow update, delete: if isAdmin();
    }

    match /contacts/{userId} {
      allow read, write: if isAdmin();
    }

    match /roles/{uid} {
      allow read: if signedIn() && request.auth.uid == uid;
      allow write: if isAdmin();
    }

    match /notices/{id} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /boardPosts/{id} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /applications_jobseeker/{id} {
      allow create: if signedIn();
      allow read: if isAdmin() || (signedIn() && resource.data.ownerUid == request.auth.uid);
      allow update, delete: if isAdmin();
    }

    match /applications_employer/{id} {
      allow create: if signedIn();
      allow read: if isAdmin(); // 구인 데이터는 관리자만
      allow update, delete: if isAdmin();
    }

    match /contactRequests/{id} {
      allow create: if signedIn()
        && isEmployer()
        && request.resource.data.employerUid == request.auth.uid
        && request.resource.data.userId is string
        && request.resource.data.status == "pending";

      allow read: if isAdmin() || (signedIn() && resource.data.employerUid == request.auth.uid);
      allow update, delete: if isAdmin();
    }
  }
}
